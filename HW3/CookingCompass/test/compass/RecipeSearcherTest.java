package compass;
import exception.BadRequestException;
import exception.FailedRequestSendingException;
import exception.ForbiddenErrorException;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;
import queryParams.Health;
import queryParams.MealType;

import java.io.File;
import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.util.List;
import java.util.Scanner;
import java.util.Set;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
public class RecipeSearcherTest {
    @Mock
    private HttpClient client;

    @InjectMocks
    private RecipeSearcher searcher;

    @Test
    void testGetRecipesSuccessfully()
        throws URISyntaxException, IOException, InterruptedException, FailedRequestSendingException,
        ForbiddenErrorException, BadRequestException {
        HttpRequest request = HttpRequest.newBuilder()
            .uri(new URI("https://api.edamam.com/api/recipes/v2?type=public&q=beef%20mushroom%20cream&app_id=1006fbf6&app_key=82b0fad1d7c56f8e8edc5d563f4caa25&health=alcohol-free&health=pork-free&health=dairy-free&mealType=Lunch&mealType=Dinner"))
            .build();
        Scanner scanner = new Scanner(new File("beefMushroomResponse.txt"));
        String mockApiResponseStr = scanner.nextLine();
        HttpResponse<Object> mockHttpResponse = mock(HttpResponse.class);
        when(mockHttpResponse.statusCode()).thenReturn(200);
        when(mockHttpResponse.body()).thenReturn(mockApiResponseStr);

        ArgumentCaptor<HttpRequest> captor = ArgumentCaptor.forClass(HttpRequest.class);
        // Configuring the mock behavior
        when(client.send(Mockito.any(), Mockito.any())).thenReturn(mockHttpResponse);

        List<String> keyWords = List.of("beef", "mushroom", "cream");
        Set<Health> healthSet = Set.of(Health.ALCOHOL_FREE, Health.DAIRY_FREE, Health.PORK_FREE);
        Set<MealType> mealTypes = Set.of(MealType.DINNER, MealType.LUNCH);
        String expected = "[Recipe[label=Kobe Beef and Oyster Mushroom Meatballs, dietLabels=[], healthLabels=[Sugar-Conscious, Dairy-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, No oil added, Sulfite-Free, Kosher], ingredientLines=[14 cups minced oyster mushrooms, 9 cups panko bread crumbs, 1/4 cup minced garlic, 3 tablespoons ground black pepper, 3 tablespoons kosher salt, 5 pounds ground Kobe beef, at room temperature, 3 tablespoons dried parsley], totalWeight=4088.616172787212, cuisineType=[eastern europe], mealType=[lunch/dinner], dishType=[main course]], Recipe[label=Creamy Mushroom Barley Soup, dietLabels=[], healthLabels=[Pescatarian, Mediterranean, Dairy-Free, Wheat-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Fish-Free, Shellfish-Free, Pork-Free, Red-Meat-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, No oil added, Sulfite-Free, Kosher], ingredientLines=[? c. mushroom barley pilaf, 1 c. strong beef, chicken or vegetable bouillon, Hot sauce to taste (optional)], totalWeight=320.0, cuisineType=[american], mealType=[lunch/dinner], dishType=[soup]], Recipe[label=Creamy Beef Tips with Mushrooms, dietLabels=[], healthLabels=[Dairy-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, No oil added, Sulfite-Free], ingredientLines=[1 (14 ounce) can coconut milk, 1 cup beef broth, 8 ounces portobello mushrooms, cleaned and sliced, 1 green bell pepper, cut into strips, 1 yellow onion, cut into strips, 1 teaspoon sea salt, 1 1/2 pounds beef sirloin tips, cubed, 1 (16 ounce) package linguine pasta], totalWeight=2243.813489305802, cuisineType=[mediterranean], mealType=[lunch/dinner], dishType=[main course]], Recipe[label=Coconut Cream Mushroom Soup in Da' Crock Pot, dietLabels=[Low-Carb], healthLabels=[Sugar-Conscious, Keto-Friendly, Dairy-Free, Gluten-Free, Wheat-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, Sulfite-Free, Kosher, Immuno-Supportive], ingredientLines=[1 cup boiling water, 1 1?2 lbs fresh mushrooms, trimmed and sliced (mixed -your choice of varieties), 2 onions, finely chopped, 4 garlic cloves, minced, 1?2 teaspoon dried thyme leaves or 2 sprigs fresh thyme, 1 teaspoon sea salt, 1?2 teaspoon black peppercorns (cracked), 1 bay leaf, 4 cups vegetable broth or 4 cups beef broth, 1 cup coconut milk (homemade -see my recipe), 4 tablespoons virgin coconut oil], totalWeight=2374.680958166913, cuisineType=[american], mealType=[lunch/dinner], dishType=[soup]], Recipe[label=Beef and Mushrooms with Pasta, dietLabels=[High-Fiber], healthLabels=[Dairy-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, Sulfite-Free], ingredientLines=[2 tablespoons olive oil, 3.333 cups rump or sirloin Steak (cut into strips), 1 onion (chopped), 2 cups button Mushrooms (sliced), 1 cup Oat cream (or soy), 1 tablespoon tomato puree, 1 teaspoon Dijon mustard, 3 teaspoons freshly chopped thyme, salt, freshly ground Black pepper, 1 lemon (juice), 14 ounces wide ribbon pasta], totalWeight=1806.4334446721252, cuisineType=[italian], mealType=[lunch/dinner], dishType=[main course]], Recipe[label=Slow Cooker Beef Stroganoff (Paleo, Dairy-Free, Whole 30) recipes, dietLabels=[High-Protein, Low-Carb], healthLabels=[Sugar-Conscious, Dairy-Free, Gluten-Free, Wheat-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, No oil added, Kosher], ingredientLines=[1.5 lbs lean stew beef, ? large white onion, chopped, 3 cloves garlic, minced, 10 oz sliced mushrooms, 1? cup beef broth, ? cup coconut amines or GF tamari soy sauce, ? cup red wine vinegar, ? tsp onion powder, ? tsp garlic powder, ? cup canned coconut milk or coconut cream, 3 tbsp arrowroot starch*, 2 tbsp water], totalWeight=1648.9573158128114, cuisineType=[eastern europe], mealType=[lunch/dinner], dishType=[main course]], Recipe[label=Paleo Beef Stroganoff, dietLabels=[Low-Carb, Low-Sodium], healthLabels=[Sugar-Conscious, Keto-Friendly, Dairy-Free, Gluten-Free, Wheat-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, Sulfite-Free, Kosher], ingredientLines=[1 small tomato, 1 clove garlic, 1 brown onion, Halved, 60 g coconut oil, 1 tablespoon paprika ground, 500 g Beef, Cut into strips, 3/4 can coconut cream, About 300ml, 1 tablespoon Golden Syryp, 1 tablespoon GF Cornflour, Optional, keep out for paleo, 1 pinch salt and pepper to taste, Quick grind, 2 carrots, Peeled and sliced, 2 leaves Kale, Cut from the stem, 1/2 red capsicum, Sliced, 100 g Mushrooms sliced, About a cup full], totalWeight=1453.6989583338798, cuisineType=[eastern europe], mealType=[lunch/dinner], dishType=[main course]], Recipe[label=Arabic Beef Rice Recipe, dietLabels=[], healthLabels=[Sugar-Conscious, Dairy-Free, Gluten-Free, Wheat-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, Sulfite-Free, Kosher], ingredientLines=[1 Leek (washed, diced), 1 Pack Lean Beef Mince, 4 Mushrooms (diced), 1/4 Cup Creamed/Sieved Tomatoes, Few Drops Water, 1 Garlic Clove, 2 Carrots (roughly grated large), 3 Handfuls Freshly Washed Spinach Leaves, Large Pinch Dried Chives, 1/2 tsp Kalonji Seeds, 1 tsp Pomegranate Seeds, Pinch Cinnamon, 1/2 tsp Dried Thyme, 1 tsp Cumin Seeds, 1/4 tsp Dried Basil, 1 tsp Paprika, Salt and Pepper to Season, Freshly Cooked Basmati Rice (2/3 - 1 Cup Dried Rice), Olive Oil], totalWeight=627.9594133812564, cuisineType=[mediterranean], mealType=[lunch/dinner], dishType=[main course]], Recipe[label=Crock Pot Beef Rogan Josh, dietLabels=[Low-Carb], healthLabels=[Dairy-Free, Gluten-Free, Wheat-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, Kosher], ingredientLines=[1 lb sliced chuck steak, 1 large onion, fairly thinly sliced, 3 garlic cloves, sliced, 3 tablespoons rogan josh curry paste, 1 (14 ounce) can plum tomatoes, 1 tablespoon mango chutney, 2 tablespoons creamed coconut, 6 ounces small mushrooms, quartered, 3 tablespoons canola oil, 1 beef stock cube, 1 1?2 cups boiling water], totalWeight=1658.065187249831, cuisineType=[central europe], mealType=[lunch/dinner], dishType=[main course]], Recipe[label=Lamb Quinoa and Veggie Dinner, dietLabels=[Low-Carb, Low-Sodium], healthLabels=[Sugar-Conscious, Mediterranean, Dairy-Free, Gluten-Free, Wheat-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, Sulfite-Free, Kosher], ingredientLines=[1 cup cooked quinoa (or brown rice), 300g Lamb (or lentils/beef/chicken), diced into small chunks, 2 zucchini, sliced, 1/2 brown onion, finely sliced, 1/2 cup green peas, 1/2 cup broccoli florets, 1 cup sweet potato, diced, 1 small tin creamed corn (or make your own), 3 button mushrooms, peeled, chopped, 1 parsnip, peeled, chopped, 1 tbs chia seeds (optional), 2 cups salt reduced vegetable stock* (or make your own), Extra virgin olive oil], totalWeight=1961.8228, cuisineType=[middle eastern], mealType=[lunch/dinner], dishType=[starter]], Recipe[label=Thick and Savory Chili, dietLabels=[High-Fiber], healthLabels=[Dairy-Free, Gluten-Free, Wheat-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, No oil added, Kosher], ingredientLines=[2 pounds lean ground beef, 1 large sweet onion (such as Vidalia�), diced, 1 tablespoon garlic powder, 2 (15 ounce) cans whole tomatoes, cut into chunks, 2 (15 ounce) cans mild chili beans, 1 (15 ounce) can tomato sauce, 1 (15 ounce) can kidney beans, drained and rinsed, 1 cup ketchup, 1 (6 ounce) can tomato paste, 2 (6 ounce) jars mushrooms, drained, 1/4 cup chili powder, or to taste, 2 teaspoons white sugar (optional), 1 1/2 teaspoons salt, 1 teaspoon ground black pepper], totalWeight=4675.083237500541, cuisineType=[american], mealType=[lunch/dinner], dishType=[main course]], Recipe[label=Porcupine Meatballs, dietLabels=[], healthLabels=[Dairy-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, No oil added, Sulfite-Free, Kosher], ingredientLines=[1 egg, lightly beaten, 1/2 cup uncooked instant rice, 2 tablespoons finely chopped onion, 1 tablespoon minced fresh parsley, 1/2 teaspoon salt, 1/4 teaspoon pepper, 1 pound lean ground beef, 1 (10.75 ounce) can condensed tomato soup, undiluted, 1 cup water, 1 teaspoon Worcestershire sauce], totalWeight=1168.5618292727438, cuisineType=[british], mealType=[lunch/dinner], dishType=[main course]], Recipe[label=Old Fashioned Mushroom Barley Soup, dietLabels=[], healthLabels=[Sugar-Conscious, Kidney-Friendly, Keto-Friendly, Dairy-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, Sulfite-Free, Kosher], ingredientLines=[3 tablespoons olive oil, divided, 12 ounces medium button mushrooms, sliced, 12 ounces boneless beef chuck cut into a small dice, 1 large onion, diced, 1 stalk celery cut into a small dice, 1 carrot cut into a small dice, 2 cloves minced garlic, 1 bay leaf, 1/4 teaspoon dried thyme leaves, 1 teaspoon salt, 1 teaspoon black pepper, 2 cups beef broth, 8 cups chicken broth, 1 cup quick cooking pearl barley ( add an extra 1/2 cup for a thicker soup), 2 tablespoons Worcestershire sauce], totalWeight=3605.638555, cuisineType=[american], mealType=[lunch/dinner], dishType=[soup]], Recipe[label=Turkish \"Lady's Tight\" Meatballs, dietLabels=[Low-Carb, Low-Sodium], healthLabels=[Sugar-Conscious, Dairy-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, Sulfite-Free, Kosher], ingredientLines=[1 pound ground beef, 1/4 cup cooked rice, 1 piece onion, 1 handful parsley, 4 pieces eggs, 1/4 teaspoon all spice, 1/4 teaspoon cumin, 1/2 teaspoon dried mint, 1 cup flour, 1 pinch grated garlic, 2 cups olive oil], totalWeight=1356.019453333558, cuisineType=[middle eastern], mealType=[lunch/dinner], dishType=[main course]], Recipe[label=John Legend�s Hearty Chili, dietLabels=[High-Fiber], healthLabels=[Dairy-Free, Gluten-Free, Wheat-Free, Egg-Free, Peanut-Free, Tree-Nut-Free, Soy-Free, Fish-Free, Shellfish-Free, Pork-Free, Crustacean-Free, Celery-Free, Mustard-Free, Sesame-Free, Lupine-Free, Mollusk-Free, Alcohol-Free, No oil added, Kosher], ingredientLines=[1 Pound ground beef, 1 medium onion, chopped, 1 Cup mushrooms, chopped, 2 Tablespoons seasoned salt, preferably Lawry�s, 3 Tablespoons chili powder, 1 Teaspoon ground red pepper, 3 garlic cloves, minced, 2 Cups water, 2 15-ounce cans tomato sauce, 2 15-ounce cans kidney beans, drained and rinsed, 2 Tablespoons light brown sugar], totalWeight=2861.9693971665174, cuisineType=[american], mealType=[lunch/dinner], dishType=[main course]]]";
        var result =  searcher.getRecipes(keyWords, healthSet, mealTypes);
        assertEquals(expected, result.toString());

        verify(client).send(captor.capture(), Mockito.any());
        assertTrue(captor.getValue().uri().toString().contains("beef"));
        assertTrue(captor.getValue().uri().toString().contains("mushroom"));
        assertTrue(captor.getValue().uri().toString().contains("cream"));
        assertTrue(captor.getValue().uri().toString().contains("alcohol-free"));
        assertTrue(captor.getValue().uri().toString().contains("pork-free"));
        assertTrue(captor.getValue().uri().toString().contains("dairy-free"));
        assertTrue(captor.getValue().uri().toString().contains("Lunch"));
        assertTrue(captor.getValue().uri().toString().contains("Dinner"));
    }
}
